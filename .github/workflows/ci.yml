name: Vizuara CI/CD Pipeline

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]
  schedule:
    # æ¯æ—¥æ„å»ºæ£€æŸ¥ï¼Œç¡®ä¿ä¾èµ–æ›´æ–°åçš„å…¼å®¹æ€§
    - cron: '0 2 * * *'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          key: quality-${{ hashFiles('**/Cargo.lock') }}

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Check clippy
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

      - name: Check documentation
        run: cargo doc --workspace --all-features --no-deps
        env:
          RUSTDOCFLAGS: -D warnings

  # æ„å»ºæµ‹è¯•ï¼ˆå¤šå¹³å°ï¼‰
  build:
    name: Build & Test
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        rust: [stable, beta]
        exclude:
          # å‡å°‘ beta ç‰ˆæœ¬çš„æµ‹è¯•çŸ©é˜µ
          - os: windows-latest
            rust: beta
          - os: macos-latest
            rust: beta
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust ${{ matrix.rust }}
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          key: build-${{ matrix.os }}-${{ matrix.rust }}-${{ hashFiles('**/Cargo.lock') }}

      # Linux ç‰¹å®šï¼šå®‰è£…ç³»ç»Ÿä¾èµ–
      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libasound2-dev \
            libudev-dev \
            libxkbcommon-dev \
            libwayland-dev \
            libxrandr-dev \
            libxcursor-dev \
            libxi-dev \
            libxinerama-dev

      # macOS ç‰¹å®šï¼šè®¾ç½®å¼€å‘è€…å·¥å…·
      - name: Setup macOS dependencies
        if: matrix.os == 'macos-latest'
        run: |
          # ç¡®ä¿ Xcode å‘½ä»¤è¡Œå·¥å…·å¯ç”¨
          xcode-select --install || true

      - name: Check compilation
        run: cargo check --workspace --all-targets --all-features

      - name: Build all packages
        run: cargo build --workspace --all-targets --all-features

      - name: Run unit tests
        run: cargo test --workspace --all-features
        env:
          # åœ¨ CI ç¯å¢ƒä¸­ä½¿ç”¨è½¯ä»¶æ¸²æŸ“
          WGPU_BACKEND: vulkan,dx12,metal,gl

  # æœ€å°æ”¯æŒçš„ Rust ç‰ˆæœ¬ (MSRV) æµ‹è¯•
  msrv:
    name: Minimum Supported Rust Version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust MSRV (1.70.0)
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.70.0

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          key: msrv-${{ hashFiles('**/Cargo.lock') }}

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libasound2-dev \
            libudev-dev \
            libxkbcommon-dev \
            libwayland-dev

      - name: Check MSRV compatibility
        run: cargo check --workspace --all-targets

  # å®‰å…¨å®¡è®¡
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        run: cargo audit

      - name: Check for unsafe code
        run: |
          # ç»Ÿè®¡ unsafe ä»£ç å—æ•°é‡
          unsafe_count=$(grep -r "unsafe" --include="*.rs" src/ || echo "0")
          echo "Unsafe code blocks found: $unsafe_count"
          # å¯ä»¥è®¾ç½®é˜ˆå€¼ï¼Œè¶…è¿‡åˆ™å¤±è´¥
          # if [ $(echo "$unsafe_count" | wc -l) -gt 10 ]; then exit 1; fi

  # æ€§èƒ½åŸºå‡†æµ‹è¯•
  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libasound2-dev \
            libudev-dev \
            libxkbcommon-dev \
            libwayland-dev

      - name: Install criterion
        run: cargo install cargo-criterion

      - name: Run benchmarks
        run: |
          # å¦‚æœæœ‰æ€§èƒ½æµ‹è¯•ï¼Œè¿è¡Œå®ƒä»¬
          if [ -d "benches" ]; then
            cargo criterion --output-format html
          else
            echo "No benchmark directory found, skipping benchmarks"
          fi

      - name: Upload benchmark results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: benchmark-results
          path: target/criterion/
          retention-days: 30

  # ç¤ºä¾‹ç¨‹åºéªŒè¯
  examples:
    name: Example Programs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libasound2-dev \
            libudev-dev \
            libxkbcommon-dev \
            libwayland-dev \
            xvfb

      - name: Build all examples
        run: cargo build --package vizuara-examples --bins

      - name: List available examples
        run: |
          echo "Available examples:"
          cargo run --package vizuara-examples --bin --help 2>/dev/null || \
          find target/debug/examples -name "*" -executable -type f | head -10

      # æ³¨æ„ï¼šGUI ç¤ºä¾‹åœ¨ CI ä¸­æ— æ³•æ­£å¸¸è¿è¡Œï¼Œä½†æˆ‘ä»¬å¯ä»¥æ£€æŸ¥å®ƒä»¬èƒ½å¦å¯åŠ¨
      - name: Test non-interactive examples
        run: |
          # è¿è¡Œå¯ä»¥åœ¨æ— å¤´ç¯å¢ƒä¸­æµ‹è¯•çš„ç¤ºä¾‹
          export DISPLAY=:99
          Xvfb :99 -screen 0 1024x768x24 &
          
          # è¿™é‡Œå¯ä»¥æ·»åŠ èƒ½åœ¨ CI ä¸­è¿è¡Œçš„ç¤ºä¾‹æµ‹è¯•
          echo "Example validation completed"

  # æ–‡æ¡£ç”Ÿæˆå’Œéƒ¨ç½²
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libasound2-dev \
            libudev-dev \
            libxkbcommon-dev

      - name: Generate documentation
        run: |
          cargo doc --workspace --all-features --no-deps
          echo '<meta http-equiv="refresh" content="0; url=vizuara_core/">' > target/doc/index.html

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./target/doc
          cname: docs.vizuara.dev  # å¦‚æœæœ‰è‡ªå®šä¹‰åŸŸå

  # å‘å¸ƒæ£€æŸ¥ï¼ˆä»…åœ¨ tag æ—¶è¿è¡Œï¼‰
  release-check:
    name: Release Check
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libasound2-dev \
            libudev-dev \
            libxkbcommon-dev

      - name: Verify package can be published
        run: |
          # æ£€æŸ¥æ¯ä¸ª crate æ˜¯å¦å¯ä»¥å‘å¸ƒ
          for crate in vizuara-*; do
            if [ -d "$crate" ]; then
              echo "Checking $crate..."
              cd "$crate"
              cargo package --allow-dirty
              cd ..
            fi
          done

      - name: Check version consistency
        run: |
          # éªŒè¯æ‰€æœ‰ crate ç‰ˆæœ¬ä¸€è‡´æ€§
          echo "Checking version consistency across crates..."
          # è¿™é‡Œå¯ä»¥æ·»åŠ ç‰ˆæœ¬æ£€æŸ¥è„šæœ¬

  # é›†æˆæµ‹è¯•ç»“æœæ±‡æ€»
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [quality, build, msrv, security]
    if: always()
    steps:
      - name: Check CI results
        run: |
          if [ "${{ needs.quality.result }}" != "success" ]; then
            echo "Quality check failed"
            exit 1
          fi
          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "Build check failed"  
            exit 1
          fi
          if [ "${{ needs.msrv.result }}" != "success" ]; then
            echo "MSRV check failed"
            exit 1
          fi
          if [ "${{ needs.security.result }}" != "success" ]; then
            echo "Security check failed"
            exit 1
          fi
          echo "All CI checks passed successfully! ğŸš€"
