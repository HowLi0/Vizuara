name: Vizuara CI/CD Pipeline

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]
  schedule:
    # æ¯æ—¥æ„å»ºæ£€æŸ¥ï¼Œç¡®ä¿ä¾èµ–æ›´æ–°åçš„å…¼å®¹æ€§
    - cron: '0 2 * * *'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          key: quality-${{ hashFiles('**/Cargo.lock') }}

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Check clippy
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

      - name: Check documentation
        run: cargo doc --workspace --all-features --no-deps
        env:
          RUSTDOCFLAGS: -D warnings

  # æ„å»ºæµ‹è¯•ï¼ˆå¤šå¹³å°ï¼‰
  build:
    name: Build & Test
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        rust: [stable]
        include:
          # åªåœ¨ Ubuntu ä¸Šæµ‹è¯• beta ç‰ˆæœ¬
          - os: ubuntu-latest
            rust: beta
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust ${{ matrix.rust }}
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          key: build-${{ matrix.os }}-${{ matrix.rust }}-${{ hashFiles('**/Cargo.lock') }}

      # Linux ç‰¹å®šï¼šå®‰è£…ç³»ç»Ÿä¾èµ–
      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libasound2-dev \
            libudev-dev \
            libxkbcommon-dev \
            libwayland-dev \
            libxrandr-dev \
            libxcursor-dev \
            libxi-dev \
            libxinerama-dev

      # macOS ç‰¹å®šï¼šè®¾ç½®å¼€å‘è€…å·¥å…·
      - name: Setup macOS dependencies
        if: matrix.os == 'macos-latest'
        run: |
          # ç¡®ä¿ Xcode å‘½ä»¤è¡Œå·¥å…·å¯ç”¨
          xcode-select --install || true

      - name: Check compilation
        run: cargo check --workspace --all-targets --all-features

      - name: Build all packages
        run: cargo build --workspace --all-targets --all-features

      - name: Run unit tests
        run: cargo test --workspace --all-features
        env:
          # åœ¨ CI ç¯å¢ƒä¸­ä½¿ç”¨è½¯ä»¶æ¸²æŸ“
          WGPU_BACKEND: vulkan,dx12,metal,gl

  # æœ€å°æ”¯æŒçš„ Rust ç‰ˆæœ¬ (MSRV) æµ‹è¯•
  msrv:
    name: Minimum Supported Rust Version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust MSRV (1.70.0)
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.70.0

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          key: msrv-${{ hashFiles('**/Cargo.lock') }}

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libasound2-dev \
            libudev-dev \
            libxkbcommon-dev \
            libwayland-dev

      - name: Check MSRV compatibility
        run: cargo check --workspace --all-targets

  # å®‰å…¨å®¡è®¡
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        run: cargo audit

      - name: Check for unsafe code
        run: |
          # ç»Ÿè®¡ unsafe ä»£ç å—æ•°é‡
          echo "Checking for unsafe code usage..."
          unsafe_count=$(find . -name "*.rs" -not -path "./target/*" -exec grep -l "unsafe" {} \; | wc -l)
          echo "Files with unsafe code: $unsafe_count"
          # ç›®å‰å…è®¸æœ‰é™çš„ unsafe ä»£ç ï¼Œä¸»è¦åœ¨ WGPU å’Œåº•å±‚æ¸²æŸ“ä»£ç ä¸­

  # ç¤ºä¾‹ç¨‹åºéªŒè¯
  examples:
    name: Example Programs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libasound2-dev \
            libudev-dev \
            libxkbcommon-dev \
            libwayland-dev \
            xvfb

      - name: Build all examples
        run: cargo build --package vizuara-examples --bins

      - name: Test non-interactive examples
        run: |
          # è¿è¡Œå¯ä»¥åœ¨æ— å¤´ç¯å¢ƒä¸­æµ‹è¯•çš„ç¤ºä¾‹
          export DISPLAY=:99
          Xvfb :99 -screen 0 1024x768x24 &
          sleep 3
          
          echo "Example builds completed successfully"
          # GUI ç¤ºä¾‹åœ¨ CI ä¸­æ— æ³•æ­£å¸¸è¿è¡Œï¼Œä½†æ„å»ºæˆåŠŸè¡¨æ˜ä»£ç æ­£ç¡®

  # æ–‡æ¡£ç”Ÿæˆå’Œéƒ¨ç½²
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libasound2-dev \
            libudev-dev \
            libxkbcommon-dev

      - name: Generate documentation
        run: |
          cargo doc --workspace --all-features --no-deps
          echo '<meta http-equiv="refresh" content="0; url=vizuara_core/">' > target/doc/index.html

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./target/doc

  # å‘å¸ƒæ£€æŸ¥ï¼ˆä»…åœ¨ tag æ—¶è¿è¡Œï¼‰
  release-check:
    name: Release Check
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libasound2-dev \
            libudev-dev \
            libxkbcommon-dev

      - name: Verify package can be published
        run: |
          # æ£€æŸ¥æ¯ä¸ª crate æ˜¯å¦å¯ä»¥å‘å¸ƒ
          for crate in vizuara-*; do
            if [ -d "$crate" ]; then
              echo "Checking $crate..."
              cd "$crate"
              cargo package --allow-dirty
              cd ..
            fi
          done

      - name: Check version consistency
        run: |
          # éªŒè¯æ‰€æœ‰ crate ç‰ˆæœ¬ä¸€è‡´æ€§
          echo "Checking version consistency across crates..."
          # è¿™é‡Œå¯ä»¥æ·»åŠ ç‰ˆæœ¬æ£€æŸ¥è„šæœ¬

  # é›†æˆæµ‹è¯•ç»“æœæ±‡æ€»
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [quality, build, msrv, security]
    if: always()
    steps:
      - name: Check CI results
        run: |
          if [ "${{ needs.quality.result }}" != "success" ]; then
            echo "Quality check failed"
            exit 1
          fi
          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "Build check failed"  
            exit 1
          fi
          if [ "${{ needs.msrv.result }}" != "success" ]; then
            echo "MSRV check failed"
            exit 1
          fi
          if [ "${{ needs.security.result }}" != "success" ]; then
            echo "Security check failed"
            exit 1
          fi
          echo "All CI checks passed successfully! ğŸš€"
